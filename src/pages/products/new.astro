---
/**
 * Formulario para crear nuevo producto
 */
import Layout from '../../layouts/Layout.astro';
import Input from '../../components/ui/Input.astro';
import Button from '../../components/ui/Button.astro';
import { productService } from '../../lib/services/productService';

let error = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString() || '';
    const description = formData.get('description')?.toString() || '';
    const price_one_payment = parseFloat(formData.get('price_one_payment')?.toString() || '0');
    const price_subscription = parseFloat(formData.get('price_subscription')?.toString() || '0');

    if (!name) {
      error = 'El nombre es obligatorio';
    } else if (price_one_payment < 0 || price_subscription < 0) {
      error = 'Los precios no pueden ser negativos';
    } else {
      await productService.create({ name, description, price_one_payment, price_subscription });
      return Astro.redirect('/products');
    }
  } catch (e) {
    console.error('Error al crear producto:', e);
    error = 'Error al crear el producto. Verifica los datos.';
  }
}
---

<Layout title="Nuevo Producto - SoftControl CRM">
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">Nuevo Producto</h1>
    </div>

    {error && (
      <div class="alert alert-error">{error}</div>
    )}

    <div class="card" style="max-width: 600px;">
      <form method="POST">
        <Input
          label="Nombre del Producto"
          name="name"
          required
          placeholder="Microsoft Office Professional"
        />
        
        <div style="margin-bottom: 1rem;">
          <label for="description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Descripción
          </label>
          <textarea
            id="description"
            name="description"
            rows="3"
            placeholder="Descripción del producto..."
            style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: var(--radius); font-family: inherit; font-size: 0.9375rem;"
          ></textarea>
        </div>
        
        <Input
          type="number"
          label="Precio Pago Único (€)"
          name="price_one_payment"
          required
          placeholder="299.99"
          value="0"
          step="0.01"
          min="0"
        />
        
        <Input
          type="number"
          label="Precio Suscripción Mensual (€)"
          name="price_subscription"
          required
          placeholder="12.99"
          value="0"
          step="0.01"
          min="0"
        />

        <div class="info-box">
          <p><strong>Nota:</strong> Puedes establecer uno de los precios en 0 si el producto solo se ofrece en una modalidad.</p>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
          <Button type="submit" variant="primary">
            Crear Producto
          </Button>
          <a href="/products" style="text-decoration: none;">
            <Button type="button" variant="secondary">
              Cancelar
            </Button>
          </a>
        </div>
      </form>
    </div>
  </div>
</Layout>

<style>
  .alert-error {
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  .info-box {
    padding: 1rem;
    background: #e0f2fe;
    border: 1px solid #7dd3fc;
    border-radius: var(--radius);
    margin-bottom: 1rem;
  }

  .info-box p {
    margin: 0;
    font-size: 0.875rem;
    color: #075985;
  }
</style>
